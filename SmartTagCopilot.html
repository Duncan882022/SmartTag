<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <title>Smart Copilot</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <!-- Office.js ƒë·ªÉ h·ªó tr·ª£ ch√®n v√†o Word khi ch·∫°y trong Add-in -->
  <script src="https://appsforoffice.microsoft.com/lib/1/hosted/office.js"></script>
  <style>
    :root{
      --brand:#0078d4;
      --bg:#f5f6fa;
      --panel:#ffffff;
      --pill:#e7f3ff;
      --text:#1f2328;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:var(--bg);font-family:Segoe UI,system-ui,-apple-system,Arial}
    .wrap{
      max-width:560px;height:100%;margin:0 auto;padding:16px;
      display:flex;flex-direction:column;gap:12px;
    }
    .header{font-weight:600;color:var(--text);display:flex;align-items:center;gap:8px}
    .dot{width:10px;height:10px;border-radius:50%;background:var(--brand)}
    .panel{
      flex:1;background:var(--panel);border-radius:12px;box-shadow:0 6px 20px rgba(0,0,0,.08);
      padding:14px;display:flex;flex-direction:column;gap:10px;overflow:auto;min-height:220px;
    }
    .msg{
      padding:12px;border-radius:10px;background:#f1f5ff;border-left:4px solid var(--brand);
      color:#0f172a;line-height:1.45;font-size:14px;white-space:pre-wrap
    }
    .msg.error{background:#fff1f1;border-color:#d92d20;color:#7a271a}
    .results{display:grid;grid-template-columns:1fr;gap:8px}
    .card{
      background:var(--pill);border:1px solid #d6eaff;border-radius:10px;padding:10px;cursor:pointer
    }
    .card:hover{outline:2px solid var(--brand)}
    .ttl{font-weight:600;margin-bottom:4px}
    .desc{font-size:12px;color:#475569;margin-bottom:6px}
    .val{font-family:Consolas,monospace;font-size:12px;background:#fff;border:1px dashed #bcd6f3;padding:4px 6px;border-radius:6px;display:inline-block}
    .inputBar{
      display:flex;gap:8px;align-items:center;background:var(--panel);border-radius:12px;
      box-shadow:0 10px 30px rgba(0,0,0,.08);padding:10px 10px 10px 12px;position:sticky;bottom:0
    }
    #kw{
      flex:1;border:1px solid #e5e7eb;border-radius:10px;padding:10px 12px;font-size:14px;
      outline:none
    }
    #kw:focus{border-color:var(--brand);box-shadow:0 0 0 3px rgba(0,120,212,.15)}
    .btn{
      border:0;background:var(--brand);color:#fff;border-radius:10px;padding:10px 16px;cursor:pointer;font-weight:600
    }
    .btn:active{transform:translateY(1px)}
    .hint{font-size:12px;color:#64748b}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="header"><span class="dot"></span>Smart Copilot</div>

    <div id="panel" class="panel">
      <div id="log" class="msg">‚úÖ S·∫µn s√†ng. G√µ t·ª´ kh√≥a (v√≠ d·ª•: <b>ng√†y</b>, <b>s·ªë</b>...) r·ªìi nh·∫•n T√¨m.</div>
      <div id="results" class="results"></div>
    </div>

    <div class="inputBar">
      <input id="kw" type="text" placeholder="Nh·∫≠p @tag ho·∫∑c t·ª´ kh√≥a..." />
      <button id="go" class="btn">T√¨m</button>
    </div>
    <div class="hint">‚Ä¢ Kh√¥ng l∆∞u l·ªãch s·ª≠. K·∫øt qu·∫£ m·ªõi s·∫Ω thay th·∫ø ph·∫ßn hi·ªÉn th·ªã b√™n tr√™n.</div>
  </div>

<script>
/* ===== Helpers ===== */
const $ = (id)=>document.getElementById(id);
const state = {
  isOffice: typeof Office!=='undefined' && !!Office.onReady,
  isSharePoint: typeof _spPageContextInfo!=='undefined'
};

function showMsg(text, type='info'){
  const log = $('log');
  log.className = 'msg' + (type==='error' ? ' error' : '');
  log.innerHTML = text;
}

function showResults(items){
  const box = $('results');
  box.innerHTML = '';
  items.forEach(it=>{
    const card = document.createElement('div');
    card.className = 'card';
    card.title = (it.Desc||'');
    card.innerHTML = `
      <div class="ttl">${escapeHtml(it.Title||'')}</div>
      <div class="desc">${escapeHtml(it.Desc||'')}</div>
      <div class="val">${escapeHtml(it.Value||'')}</div>
    `;
    card.onclick = ()=> onPick(it);
    box.appendChild(card);
  });
}

function escapeHtml(s){return String(s||'').replace(/[&<>"]/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]))}

/* ===== Insert to Word if available ===== */
async function insertToWord(text){
  if(!state.isOffice) return false;
  try{
    await Office.onReady();
    await Word.run(async ctx=>{
      const sel = ctx.document.getSelection();
      sel.insertText(text, Word.InsertLocation.replace);
      await ctx.sync();
    });
    showMsg('‚úçÔ∏è ƒê√£ ch√®n v√†o t√†i li·ªáu Word: ' + text);
    return true;
  }catch(e){
    showMsg('‚ùå Kh√¥ng th·ªÉ ch√®n v√†o Word: ' + e.message, 'error');
    return false;
  }
}

/* ===== Behaviors ===== */
async function onPick(tag){
  // ∆∞u ti√™n ch√®n v√†o Word, n·∫øu kh√¥ng th√¨ copy clipboard
  const ok = await insertToWord(tag.Value||'');
  if(!ok){
    try{
      await navigator.clipboard.writeText(tag.Value||'');
      showMsg('üìã ƒê√£ copy v√†o clipboard: ' + (tag.Value||''));
    }catch{
      showMsg('‚ÑπÔ∏è Gi√° tr·ªã: ' + (tag.Value||'') + ' (copy th·ªß c√¥ng n·∫øu c·∫ßn)');
    }
  }
}

async function search(){
  const q = $('kw').value.trim();
  if(!q){ showMsg('‚ÑπÔ∏è Nh·∫≠p t·ª´ kh√≥a ƒë·ªÉ t√¨m trong TagLibrary.'); $('results').innerHTML=''; return; }

  // m·ªói l·∫ßn t√¨m: clear k·∫øt qu·∫£ c≈© (kh√¥ng gi·ªØ l·ªãch s·ª≠)
  $('results').innerHTML='';
  showMsg('üîé ƒêang t√¨m: ' + q);

  try{
    let rows = [];
    if(state.isSharePoint){
      const site = _spPageContextInfo.webAbsoluteUrl;
      const url = `${site}/_api/web/lists/getbytitle('TagLibrary')/items?$select=Title,Value,Desc`;
      const r = await fetch(url,{headers:{Accept:'application/json;odata=verbose'}, credentials:'same-origin'});
      if(!r.ok) throw new Error('HTTP ' + r.status);
      const data = await r.json();
      rows = (data.d && data.d.results) ? data.d.results : [];
    }else{
      // Demo khi test ngo√†i SharePoint (GitHub, c·ª•c b·ªô‚Ä¶)
      rows = [
        { Title:'S·ªë vƒÉn b·∫£n', Value:'{SoVB}', Desc:'T·ª± ƒë·ªông ƒëi·ªÅn s·ªë vƒÉn b·∫£n' },
        { Title:'Ng√†y ban h√†nh', Value:'{NgayBanHanh}', Desc:'Ng√†y k√Ω vƒÉn b·∫£n' },
        { Title:'C∆° quan ban h√†nh', Value:'{CoQuan}', Desc:'T√™n ƒë∆°n v·ªã ph√°t h√†nh' }
      ];
    }

    const found = rows.filter(t=>{
      const s = (t.Title||'') + ' ' + (t.Value||'') + ' ' + (t.Desc||'');
      return s.toLowerCase().includes(q.toLowerCase());
    });

    if(found.length===0){
      showMsg('‚ö†Ô∏è Kh√¥ng t√¨m th·∫•y k·∫øt qu·∫£ ph√π h·ª£p cho: ' + q);
      return;
    }

    showMsg('‚úÖ T√¨m th·∫•y ' + found.length + ' k·∫øt qu·∫£. Ch·∫°m ƒë·ªÉ ch√®n v√†o Word (n·∫øu ƒëang ch·∫°y Add-in).');
    showResults(found.slice(0,20));
  }catch(e){
    showMsg('‚ùå L·ªói: ' + e.message, 'error');
  }
}

/* ===== Init UI (kh√¥ng l∆∞u l·ªãch s·ª≠) ===== */
function init(){
  $('go').onclick = search;
  $('kw').addEventListener('keydown', e=>{
    if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); search(); }
  });
  // g·ª£i √Ω nh·ªè
  $('kw').placeholder = state.isSharePoint ? 'Nh·∫≠p @tag ho·∫∑c t·ª´ kh√≥a (SharePoint mode)‚Ä¶' : 'Nh·∫≠p t·ª´ kh√≥a (Demo mode)‚Ä¶';
}

if(document.readyState==='loading') document.addEventListener('DOMContentLoaded', init); else init();
</script>
</body>
</html>
